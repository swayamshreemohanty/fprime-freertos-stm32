####
# STM32H7 HAL Library for FPrime
####

# Collect all HAL sources
file(GLOB HAL_SOURCES
  ${CMAKE_CURRENT_LIST_DIR}/Drivers/STM32H7xx_HAL_Driver/Src/*.c
)

# Remove problematic DMA files (not needed for LED blinker)
list(FILTER HAL_SOURCES EXCLUDE REGEX ".*stm32h7xx_hal_dma.*")
list(FILTER HAL_SOURCES EXCLUDE REGEX ".*stm32h7xx_hal_dma2d.*")
list(FILTER HAL_SOURCES EXCLUDE REGEX ".*stm32h7xx_hal_bdma.*")
list(FILTER HAL_SOURCES EXCLUDE REGEX ".*stm32h7xx_hal_mdma.*")

# Collect Core sources
file(GLOB CORE_SOURCES
  ${CMAKE_CURRENT_LIST_DIR}/Core/Src/*.c
)

# Collect startup code
set(STARTUP_SOURCE
  ${CMAKE_CURRENT_LIST_DIR}/startup_stm32h7a3xxq.s
)

# Collect FreeRTOS sources
file(GLOB FREERTOS_SOURCES
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/*.c
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM7/r0p1/*.c
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2/*.c
)

file(GLOB FREERTOS_HEAP
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/MemMang/heap_4.c
)

# Create STM32 HAL library
add_library(stm32h7_hal STATIC
  ${HAL_SOURCES}
  ${CORE_SOURCES}
  ${STARTUP_SOURCE}
  ${FREERTOS_SOURCES}
  ${FREERTOS_HEAP}
)

# Include directories
target_include_directories(stm32h7_hal PUBLIC
  ${CMAKE_CURRENT_LIST_DIR}/Core/Inc
  ${CMAKE_CURRENT_LIST_DIR}/Drivers/STM32H7xx_HAL_Driver/Inc
  ${CMAKE_CURRENT_LIST_DIR}/Drivers/STM32H7xx_HAL_Driver/Inc/Legacy
  ${CMAKE_CURRENT_LIST_DIR}/Drivers/CMSIS/Device/ST/STM32H7xx/Include
  ${CMAKE_CURRENT_LIST_DIR}/Drivers/CMSIS/Include
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/include
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2
  ${CMAKE_CURRENT_LIST_DIR}/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM7/r0p1
)

# Compiler definitions
target_compile_definitions(stm32h7_hal PUBLIC
  USE_HAL_DRIVER
  STM32H7A3XXQ
)

# Compiler options - ensure C99 standard for proper type definitions
target_compile_options(stm32h7_hal PRIVATE
  -std=gnu11
  -Wno-unused-parameter
  -Wno-unused-variable
)

# Set language for assembly files
set_source_files_properties(${STARTUP_SOURCE} PROPERTIES LANGUAGE ASM)
